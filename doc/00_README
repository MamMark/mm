
Installing a development environment for the MamMark tag.  TinyOS, Ubuntu,
Wine Jtag.

This brief is written assuming that there is a common root directory,
we'll call it mm and it is usually at the top level of a working
directory.  ie.  ~/mm.

Most commands are entered from a terminal window.


**************************************************************************************

1) OS Install.

Install the Ubuntu 9.10 on the box.  A simple install is fine and will
take less time. Download the install ISO from
http://www.ubuntu.com/getubuntu/download.

When the install is complete, boot the system, and use Synaptic or other package
manager ("apt-get install") to make sure the following packages are installed:

    build-essential stow automake autoconf libtool libc6-dev
    git-core git-daemon-run git-doc git-email git-gui gitk gitmagic
    openssh-client openssh-server

The following will do the trick:

sudo -s
apt-get install build-essential stow automake autoconf libtool libc6-dev
apt-get install git-core git-daemon-run git-doc git-email git-gui gitk gitmagic
apt-get install openssh-client openssh-server
exit


**************************************************************************************

2) Install TinyOS toolset (msp430)

We want the tinyos toolset for the msp430 (telosb). Debian packages
are available from Stanford.

We want the following packages:

           deputy-tinyos
           msp430-binutils-tinyos
           msp430-gcc-tinyos
           msp430-libc-tinyos
           msp430-tinyos
           msp430-tinyos-base
           nesc
           tinyos-base
           tinyos-tools

sudo -s
echo "deb http://tinyos.stanford.edu/tinyos/dists/ubuntu karmic main" >> /etc/apt/sources.list
apt-get update
apt-get install deputy-tinyos msp430-binutils-tinyos msp430-gcc-tinyos msp430-libc-tinyos
apt-get install msp430-tinyos msp430-tinyos-base nesc tinyos-base tinyos-tools
exit


However we also want a modified toolchain that supports the msp430x
architecture.  Currently the simplest way to install all this stuff is
to start with the tinyos-2.1.0 deb file and then overlay the z1
toolchain from Zolertia (http://zolertia.sourceforge.net/wiki/index.php/Getting_Started_with_Z1)

First:

sudo apt-get install tinyos-2.1.0


Then download and install tinyos-z1-0.0.1-13_i386.deb
from (http://sourceforge.net/projects/zolertia/files/).

sudo dpkg -i tinyos-z1-0.0.1.-13_i386.deb


This will install the tinyos source code as of the 2.1.0 release and
add in the z1 changes on top of it.  The part we use however is
the z1 toolchain which has a working msp430-gcc that supports the 430x
chips.  We don't actually use the source code, just the tool chain.

This is a temporary measure because cleaning this up involves a
somewhat involved learning curve.

The Z1 toolchain lives at /opt/msp430-z1 the corresponding bin and lib
lib directories must be included in environment variables.

$PATH needs to be modified to search /opt/msp430-z1 first.   This can
be done later and is described in section 8.


**************************************************************************************

3) Install wine, Python, pyserial, and pywin32.

We need wine in order to run msp430-gdbproxy and msp430-jtag.

Details can be found at: http://www.winehq.org/download/deb

Add the ppa:ubuntu-wine/ppa repository and install wine1.2:

sudo -s
add-apt-repository ppa:ubuntu-wine/ppa
apt-get update
apt-get install wine1.2
exit



Download the following into your home directory:
http://www.python.org/ftp/python/2.6.5/python-2.6.5.msi
http://sourceforge.net/projects/pyserial/files/pyserial/2.5-rc2/pyserial-2.5-rc2.win32.exe/download.
http://sourceforge.net/projects/pywin32/files/pywin32/Build%20214/pywin32-214.win32-py2.6.exe/download

These are windows installers.  They can be installed using wine by
navigating to the file using a file browser, click "Places->Home
Folder".  Right click on the file and select "Open with Wine Windows
Program Loader".  This will bring up an installation
window.  Follow the instructions.

Install Python2.6.5, pyserial, and pywin32.  This will also start wine
up for the first time can create any special directories that Wine
might need.


**************************************************************************************

4) Pull the t2_mm tree.

Normal user (not enabled).

cd ~/mm
git clone git://hinrg.cs.jhu.edu/git/cire/t2_mm3.git t2_mm
cd t2_mm



**************************************************************************************

5) Install gdb.430, msp430-jtag, and msp430-gdbproxy.

Once a t2_mm tree has been pulled we need to install some extra items
that come from t2_mm/Added_Bit/tools.

sudo -s
cd ~/mm/t2_mm/Added_Bits/tools
make install
exit

   This will install gdb.430, msp430-jtag, and msp430-gdbproxy into
   /opt/msp430-z1/bin.  Needed libraries will be installed in appropriate
   places.

   NOTE: this step has to be done after the install of the
   tinyos-z1-0.0.1.-13_i386.deb package as a msp430-jtag is installed
   as part of that package.  We replace it.

   It will also create the link needed to associate COM1 with the jtag
   pod assuming it is connected to the system as /dev/ttyUSB0.  If you
   always plug the jtag in as the first usb device it will always be
   USB0.

   The windows version of msp430-jtag defaults to using COM1 which
   we've linked to /dev/ttyUSB0.  You can override this setting by
   passing the -l <device> switch on the command line.  These need
   to be windows devices.
   


**************************************************************************************

6) TinyOS 2.x tree checkout

Changes needed to build the mm tree can be obtained via the mm_tip
branch on the cire/tinyos-2.x.git repo.

To obtain the current mm_tip branch:

    cd ~/mm
    mkdir t2_cur
    cd t2_cur
    git clone -v git://hinrg.cs.jhu.edu/git/cire/tinyos-2.x.git
    cd tinyos-2.x
    git checkout -t origin/mm_tip


**************************************************************************************

7) Modify PATH and LD_LIBRARY_PATH

Make sure your PATH and LD_LIBRARY_PATH include /opt/msp430-z1 as
appropriate. 

   M1="/opt/msp430-z1"
   export PATH="$M1/bin:$PATH"
   export LD_LIBRARY_PATH="$M1/lib:$LD_LIBRARY_PATH:/usr/local/lib"



**************************************************************************************

8) Set up build environment settings

The following environment variables must be set to build.

    TOSROOT
    TOSDIR
    MAKERULES
    CLASSPATH
    TOSMAKE_PATH
    MM_ROOT

    for example:  working dir ~/mm
  
  	#!/bin/sh
  
  	MOTECOM="serial@/dev/ttyUSB1:telosb"
  
  	TOSROOT=~/mm/t2_cur/tinyos-2.x
  	TOSDIR=$TOSROOT/tos
  
  	MM_ROOT="/home/joe/mm/t2_mm"
  	TOSMAKE_PATH="$TOSMAKE_PATH $MM_ROOT/support/make"
  
  	M1="/opt/msp430-z1"
  	PATH="$M1/bin:$PATH"
  	LD_LIBRARY_PATH="$M1/lib:$LD_LIBRARY_PATH:/usr/local/lib"
  
  	MAN_PATH="$M1/man:$MAN_PATH"
  
  	MAKERULES=$TOSROOT/support/make/Makerules
  	CLASSPATH=.:$TOSROOT/support/sdk/java/tinyos.jar
  
  	PYTHONPATH=$TOSROOT/support/sdk/python:$PYTHONPATH
  	PYTHONPATH=$M1/lib:$M1/bin:$PYTHONPATH
  	PYTHONPATH=$M1/lib/python2.3/site-packages:$PYTHONPATH
  
  	#LIBMSPGCC_PATH=$M1/lib
  
  	export MAKERULES TOSDIR TOSROOT CLASSPATH PYTHONPATH LD_LIBRARY_PATH
  	export LIBMSPGCC MOTECOM MM_ROOT TOSMAKE_PATH PATH


**************************************************************************************

9) Do a test compile and gdb run.  This assumes that the JTAG pod is
    connected to ttyUSB0 via COM1.  The default device assumed by the
    windows version of msp430-jtag is COM1.  COM1 is automatically
    linked to /dev/ttyUSB0 when the windows versions of
    msp430-gdbproxy and msp430-jtag are installed above.
    

    For mm4 hardware:

    cd ~/mm/t2_mm/apps/mm
    make debug mm4 threads
    msp430-jtag -e build/mm4/main.exe

    When the download completes use a different window and run:

    msp430-gdbproxy msp430 COM1


    There should be a .gdbinit file in apps/mm which contains the following lines at the top:

        set remoteaddresssize 0d64
        set remotetimeout 0d999999
        target remote localhost:2000

    change into build/mm4/ and create a symbolic link to the .gdbinit file in the upper directory.
    This prevents the .gdbinit file from being wiped if one does "make clean".

        pushd build/mm4
	ln -s ../../.gdbinit
	popd

    now if you run gdb.430 build/mm4/main.exe  gdb should connect to the proxy and start
    to debug your code in the device.  To let the device run use 'c', continue.  Do not use
    'run'.


**************************************************************************************

10) Do a test compile and gdb run from the main tree.

    If you have telosb hardware:

    cd ~/mm/t2_cur/tinyos-2.x/apps/Blink
    make debug telosb
    msp430-jtag -e build/telosb/main.exe


    from a different window run:

    msp430-gdbproxy msp430 COM1


    Make sure that you have a .gdbinit file in the app directory and the symbolic link
    from the build/telosb directory as described in 13.

    run gdb as described in 13.




**************************************************************************************

11) Build SerialForwarder and libmote library.

    Build the serial forwarder and associated library (also includes direct serial access)

      cd $TOSROOT/support/sdk/c/sf
      ./bootstrap
      ./configure --prefix=/opt/stow/sf_c
      make

      sudo -s
      make install

      ("sudo make install" for some reason doesn't pick up the value of $TOSROOT properly so
      the make install doesn't work write unless you are root first)

      This will install bin/{sf, sflisten, sfsend, seriallisten, serialsend}, include/{message.h,
      serialsource.h, sfsource.h}, and lib/libmote.a.  These will be installed into /opt/stow/sf_c.


   Install into /opt/{bin,include,lib} using stow.

      cd /opt/stow
      stow sf_c


**************************************************************************************

12) We use GIT as the SCM.  Here are some pointers to get you started:

   Start here:   http://book.git-scm.com/2_setup_and_initialization.html
   Everyday GIT: http://www.kernel.org/pub/software/scm/git/docs/everyday.html
   Cheat Sheet:  http://zrusin.blogspot.com/2007/09/git-cheat-sheet.html
   SVN to GIT:   http://git-scm.com/course/svn.html
   GIT Book:     http://book.git-scm.com/
   Another Book: http://progit.org/book/




Documentation on getting started with T2 can be found at:

    http://docs.tinyos.net
    http://docs.tinyos.net/index.php/Getting_started


The main tracking repo is at:

    git://hinrg.cs.jhu.edu/git/cire/tinyos-2.x.git
        read-only, cire tracking repo that tracks hinrg t2, updated manually
	This also has the mm code, branched off the hinrg t2 mainline


**************************************************************************************

13) About the T2_MM tree.

The t2_mm tree is a seperate t2 based repo that has mammark unique
code.  It is used to build firmware for the mm3 (1611 based) and mm4
(2618 based) tag devices.

    git://hinrg.cs.jhu.edu/git/cire/t2_mm3.git (read only)

    The main branch is "master".

    Any patches etc should be emailed.  (Can be prepared with git-format-patch
    or git-log).



**************************************************************************************

14) Using the serialforwarder/seriallistener

    a) make sure that tinyos.jar has been built.  It should live in $TOSROOT/support/sdk/java/tinyos.jar
    b) to rebuild:
  
       cd $TOSROOT/support/sdk/java/
       make tinyos.jar
  
    c) Install TOSComm JNI support if needed.  Did java bitch about not finding TOSComm JNI support?
  
       assuming tinyos-tools is installed run:
  
       tos-install-jni
  
    d) To watch raw bytes coming from the serial port
  
       Make sure CLASSPATH includes $TOSROOT/support/sdk/java/tinyos.jar, ie:
  
           CLASSPATH=.:/home/joe/mm/t2_cur/tinyos-2.x/support/sdk/java/tinyos.jar

execute:

       java net.tinyos.tools.Listen -comm serial@/dev/ttyUSB0:telosb


And you should see packets that look something like this:  (depends on what the mote is sending)

            00 FF FF 00 00 12 00 A1 00 12 07 09 00 0C 9E 23 00 0C 9E 30 F6 2C FF D7 FF FF
            00 FF FF 00 00 12 00 A1 00 12 07 05 00 0C 9E 24 00 0C 9E 3F E5 AF B1 6F 9E D4
            00 FF FF 00 00 0E 00 A1 00 0E 07 06 00 0C 9E 33 00 0C 9E 46 78 80
            00 FF FF 00 00 0E 00 A1 00 0E 07 07 00 0C 9E 33 00 0C 9E 52 FF FF
            00 FF FF 00 00 10 00 A1 00 10 07 08 00 0C 9E 33 00 0C 9E 61 FF FF FF FF
  
            00 FF FF 00 00 10 00 A1 00 10 07 08 00 0C 9E 33 00 0C 9E 61 FF FF FF FF
            ^  ^     ^     ^  ^  ^  ^     ^  ^  | -- sensor 8 data
            |  |     |     |  |  |  |     |  |- sensor id
            |  |     |     |  |  |  |     |- sensor data type
            |  |     |     |  |  |  |-- length of data block
            |  |     |     |  |  |-- AM type MM_DATA
            |  |     |     |  |-- AM group
            |  |     |     |-- serial length
            |  |     |-- src addr           
            |  |-- dest addr
            |-- dispatch byte - 0 says AM
                             
If you define MOTECOM you won't need to specify the -comm parameter.  ie:

       MOTECOM=serial@/dev/ttyUSB1:telosb




**************************************************************************************

15) Repos:

T2 git repositories:

    git://hinrg.cs.jhu.edu/git/tinyos-2.x.git
	hinrg T2 core: read-only, hinrg git tracking from cvs t2 main (updated hourly)

    git://hinrg.cs.jhu.edu/git/cire/tinyos-2.x.git
	cire/tinyos-2.x: read-only.  manual update tracking of hinrg T2 core.  Also
	includes mm_tip and encap branches.

    ssh://hinrg.cs.jhu.edu/home/cire/tinyos-2.x.git
        read-write (need access permissions), cire tracking repo that tracks
        hinrg t2, updated manually (same as git://hinrg.cs.jhu.edu/git/cire/tinyos-2.x.git)

    gitosis@overtux.cse.ucsc.edu:cire/t2_cire_hinrg.git   -> tinyos-2.x
        read-write (need access perissions), cire tracking repo that tracks
        hinrg t2_cire, updated manually (same as ssh://hinrg.cs.jhu.edu/home/cire/tinyos-2.x.git)


    tinyos-2.x.git:	tracks the main t2 cvs repository (hinrg, updated hourly)

    cire/tinyos-2.x.git: manually tracking of the main hinrg t2 tree (labeled t2_base)
	t2_base:    master that tracks the main hinrg
	encap:	    encapsulation modification to the mainline
	mm_tip:     working tip for mm3 development (no encap changes)

    t2 (cvs) -> tinyos-2.x.git (hinrg, hourly) -> cire/tinyos-2.x.git (t2_base, manual)
             ----> (encap)
	     ----> (mm_tip)

    t2 (cvs) denotes the cvs based main t2 tree.   tinyos-2.x.git denotes
    the hourly pull mirror hosted at hinrg.cs.jhu.edu.  And cire/tinyos-2.x
    is the tracking branch + mm branches.


T2_MM git repositories:

    git://hinrg.cs.jhu.edu/git/cire/t2_mm3.git (read only)
	read-only, primary pull T2 MM3 repo.  pulls from /home/cire/t2_mm3.git.

    ssh://hinrg.cs.jhu.edu/home/cire/t2_mm3.git  (read write)

    gitosis@overtux.cs.ucsc.edu:cire/t2_mm3.git  (read write)  (backup)

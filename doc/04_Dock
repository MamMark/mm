
The Dock provides a high speed connection to a Tag device.  This connection
can be used to a) monitor operation of an operational tag and b) offload
large quantities of data stored on the tag.

The connection between the dock and the tag is a master/slave SPI connection.
The dock is the master and the tag is a slave.

1) HW interconnect

   DC = Dock_Comm

   SCLK:    clock sourced by the dock (master).
   SIMO:    slave in, master out, (spi data)
   SOMI:    slave out, master in, (spi data)

   DC_ATTN_M_N:
            Dock -> Tag (low true).  Master's Slave_Select (CSn).  Asserted
            for entire SPI packet transmission.

   DC_ATTN_S_N:
            Tag -> Dock (low true).  Handshake signal asserted by a tag to
            indicate a message is pending for the dock.

   DC_SPI_EN:
            Tag -> Dock.  Assertion enables connection of the Dock to the
            dock_comm spi bus.

            When DC_SPI_EN is 0, the dock's SIMO should be pulled high to
            generate bytes of 0xff.


1a) DC_ATTN_M_N

The DC_ATTN_M_N signal is used to get the tag's attention and to bracket the
data being sent to the tag.  The initiating edge indicates the start
of a new packet and the next byte will be a channel byte.  DC_ATTN_M_N
is asserted for the duration of the packet.


1b) DC_ATTN_S_N.

The DC_ATTN_S_N signal is used by the tag to inform the dock that a tag packet
is ready to be retrieved.


1c) DC_SPI_EN.

The DC_SPI_EN tells the dock to enable its connection to the dock_comm
spi bus.  This enables output drivers from the Dock for SCLK and SIMO.
When disabled, the incoming SOMI signal needs to be pulled high.

If DC_SPI_EN is stuck deasserted, the dock will not be able to communicate
with the tag.  The tag is required to participate in order for the dock_comm
interface to function properly.


1d) SCLK, SIMO, SOMI

When DC_SPI_EN is deasserted, the dock is disconnected from SCLK and SIMO and
SOMI is pulled up so any input bytes will be seen as 0xFF.

With DC_SPI_EN asserted, the dock drives SCLK and SIMO and SOMI is connected
to the dock_spi bus SOMI.


2) Data format.

Data is transfered between the dock and the tag in packets.  All multi-byte
datums are in little endian order.  There is no multi-byte alignment
constraint.

   +---------+--------+-------+--------+-----------+--------+
   | channel |  type  |  len  |  data  |  checksum |   00   |
   +---------+--------+-------+--------+-----------+--------+

       1         1        2       len         2        1*

                                                   +--------+
      0xfe      0xfe     0xfe     0xfe      <---   |  srsp  |
                                                   +--------+

   channel:     data channel, end point identifier
   type:        data type.  What's in the packet.
   len:         2 byte length.  Length indicates the length of the data field.
   data:        packet data, size is len.
   checksum:    16 bit byte by byte sum truncated to 16 bits of bytes
                between channel through last data byte inclusive.
   srsp:        simple response (srsp).


2a) Channels.

The channel field in the packet denotes a logical end point.  An end point
denotes a software module that generates or consumes packet data.

    0:  simple      simple commands and responses.
    1:  tagnet      tagnet over SPI
    2:  print       debug print.
    3:  large_dblk  large block dblk access.


2b) Type

Basic type of the packet.  Defines its format.

    0:  data    packet data
    1:  rsp     response data
    2:  error   error data, data contains error information.
    3:  poll    interrogate tag for identifing information.


2c) srsp, simple response.

For packets transmitted from the dock to the tag, a simple response
byte is returned by the tag after the last checksum byte has been sent.
This byte indicates immediate response to the packet just received.

    0:  ok
    1:  bad checksum
    2:  protocol error
    ff: not present


3) Basic Operation

The dock_comm port can be operated in two modes, DOCK_FREE, and DOCK_LOCK.

DOCK_FREE: the dock_comm spi can be freely shared between the dock_comm
as well as other devices on the spi bus.  Basically, the tag shares access
to the spi bus with dock messages.

DOCK_LOCK: after receipt of a DOCK_LOCK message, the tag keeps the dock_comm
spi port in slave mode.  This reserves the dock port for dock communications.

The dock_comm port is either connected to a dedicated slave spi or to a shared
spi bus which the tag normally accesses as a bus master.  If the tag is actively
using the spi bus it will hold off any dock communications/interactions by
deasserting DC_SPI_EN which disables the dock side drivers on SCLK and SIMO.


Initial state:  Normal tag operation.

  DC_SPI_EN:   0, disable external dock drivers if connected.
  DC_ATTN_M_N: 1, (pull up), if connected, Dock is not accessing the tag.
  DC_ATTN_S_N: 1, tag is not requesting data transfer from the dock.
  SPI bus:     the tag dock_comm spi can be configured as a master to enable
               accessing other devices on the bus.  Alternatively, the spi
               h/w can be held in reset to minimize power consumptino.


3a) Docking.  Plugging the tag into a dock shouldn't disrupt any operations
currently being performed on the tag.  (electrical issues?)  This includes
any potential transactions that are occuring on the dock_comm spi bus.

The process of docking does not generate a signal telling the tag docking has
occured.


3b) Dock Attn.  The dock gets the attention of the tag by dropping DC_ATTN_M_N.
This acts as a slave_select (chip select) and the next byte transmitted by the
dock will be a channel byte.

The falling edge of DC_ATTN_M_N typically causes an interrupt on the tag.


3c) Tag actions on receipt of DC_ATTN_M_N signal (falling edge, low value),
    ATTN_M interrupt.

If the dock_comm spi is busy (tag is master, owned by tag), the interrupt
is ignored.

Otherwise, the tag will take the following actions:

    1) configure SPI as a slave, take it out of reset.
    2) raise DC_SPI_EN
    3) set dock_com spi busy (owned by the dock)


3d) Data transfer

Once the dock owns the spi, it can begin transferring bytes.  Being the
master, the dock is responsible for initiating every transfer.  One byte
sent, one byte received.

Two major modes are needed when transferring packets between the dock and
the tag, Dock -> Tag and Dock <- Tag.

To send data from the dock to the tag, the dock will assert DC_ATTN_M_N and
start sending a packet (channel, type, len, data, ...).  If the tag is
actively receiving these bytes, 0xFE will be returned for each transmitted
byte.

When the Tag has data that it needs the dock to retrieve it will assert
DC_ATTN_S_N, the dock must send bytes to the tag in order to fetch
bytes from the tag.  (needs more detail).

Typically a sequence will look as follows:

Dock:                                   Tag:

  assert DC_ATTN_M_N                      interrupt
                                          configure SPI as slave
                                          set output byte to 0xFE
                                          assert DC_SPI_EN
                                          set dock_comm spi busy.

  sends first byte.                       interrupt, byte available
                                          process byte.

  sends bytes                             interrupt, continue processing
     ...

  sends 2nd checksum byte.                interrupt, process checksum
                                          set srsp byte to be returned.
                                          (will be returned on next
                                          transmitted byte).

  send 00                                 interrupt.  ignore last byte.

  deassert DC_ATTN_M_N


The tag will process the packet and perform the requested operation.  This
operation can take non-zero time.  When the results are available and the
response is ready, the tag will assert DC_ATTN_S_N.

Dock:                                   Tag:

                                          assert DC_ATTN_S_N

  assert DC_ATTN_M_N                      interrupt
                                          configure SPI as slave
                                          set output byte to first byte
                                          assert DC_SPI_EN
                                          set dock_comm spi busy.

  send 0xfe                               send next byte
     ...
  send 0xfe                               send 2nd checksum byte.
  send srsp                               receive srsp
  deassert DC_ATTN_M_N                    deassert DC_ATTN_S_N

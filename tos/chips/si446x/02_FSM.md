The Si446x Driver uses a finite state machine (FSM) to control all major
actions of the chip driver.

The state machine is embodied in data structures created by a code
generator using a FSM definition as input, yielding Si446xFSM.h and
Si446xFSM.py for use by the C and python driver state machines.

In addition to the primary structures used by the FSM, some helper
structures are auto-generated, such as the forward declarations for all
action functions.

Below is the graphical representation of the Si446x Driver Finite State Machine
(gh:MamMark/mm/tos/chips/si446x/Si446xFSM.png).

![Si446xDriverLayer](Si446xFSM.png)

### Creating runtime code

The source for the state machine is Si446xFSM.fsm, QFSM can read this file
and allows the user to make changes.  On output, the user writes any needed
intermediate files needed for further processing.

The Si446xFSM.txt output describes the state machine in tabular form.  This file
is input to the fsmc.py tool to generate the C and Python files used to
implement the driver state machine.

```
    Si446xFSM.fsm -> Qfsm -> Si446xFSM.txt -> fsmc.py +-> Si446xFSM.h  (c code)
         ^             |                              |
         |             v                              |
         +<------------+                              +-> Si446xFSM.py (python)
```

### Updating the FSM:

Qfsm is a graphical tool used for editing finite state machines.  It is no longer
hosted on the major repositories, so may need to be built.  See
[Building Qfsm](#building-qfsm) for instructions.

- Checkout current version of Si446xFSM.fsm (gh:MamMark/mm/tos/chips/si446x)
- Use Qfsm (graphical interface) to change state machine
- Save modified Si446xFSM.fsm
- Export ASCII file:
  - make sure to include asyncronous output, yields Si446xFSM.txt
  - rows -> events, columns -> states
- Export Si446xFSM.png file
- Export Si446xFSM.html file
- run the fsmc.py code generator (input Si446xFSM.txt file)
- Generate C code for Tag (mm) code, and Python for the TBS (basestation).
  - ```fsmc.py``` lives in gh:MamMark/mm/tools/fsmc
  - C: ```fsmc.py -i Si446xFSM.txt -o Si446xFSM.h --c-mode```
  - Python: ```fsmc.py -i Si446xFSM.txt -o Si446xFSM.py --python-mode```
- make the target platform

### IMPORTANT ARTIFACTS saved in the git repository

- Si446xFSM.fsm is the source QFSM state machine in XML.
  - Mealy-style machine where each arc (transition) is labeled with an output action.
- Si446xFSM.txt contains a textual representation of the state table, input to ```fsmc.py```.
  ```File->Export->StateTable (ASCII)```.
  - check box include asyncronous output
    Orientation: Rows: Events/Columns: States
- Si446xFSM.png is a graphical representation of the state machine diagram
- Si446xFSM.html is a web page version of the state machine table.
- Si446xFSM.h is generated by fsmc.py for use by C implementations.
- Si446xFSM.py is generated by fsmc.py for use by Python implementations.

**Note:** The Si446xFSM.py file is used by the Python Si446x driver that runs on the TBS
(basestation).  It lives in both the tag side (gh:MamMark/mm/tos/chips/si446x) and the TBS
side (gh:MamMark/TagNet/si446x/si446x).  These files should be identical.

### FINITE STATE TABLE text format

The main output file from Qfsm is a textual representation of the state machine.
Columns are indexed by State and Rows are indexed by events.  The contents of
each cell is a (next_state, action) tuple.

When fsmc.py is run on this file it will output files that can be used by
by the chip driver to implement the state machine.

```
"Events/States";"SDN";"POR_W";"CONFIG_W";"RX_ON";"RX_ACTIVE";"TX_ACTIVE";"STANDBY";"PWR_UP_W";"CRC_FLUSH"
" CONFIG_DONE";"-";"-";"RX_ON ready";"-";"-";"-";"-";"-";"-"
" CRC_ERROR";"-";"-";"-";"-";"CRC_FLUSH rx_cnt_crc";"-";"-";"-";"-"
" FIFO_OU_RUN";"-";"-";"-";"-";"RX_ON rx_overrun_reset";"RX_ON tx_underrun_reset";"-";"-";"RX_ON rx_overrun_reset"
" INVALID_SYNC";"-";"-";"-";"-";"RX_ON clear_sync";"-";"-";"-";"-"
" PACKET_RX";"-";"-";"-";"-";"RX_ON rx_cmp";"-";"-";"-";"RX_ON rx_flush"
" PACKET_SENT";"-";"-";"-";"-";"-";"RX_ON tx_cmp";"-";"-";"-"
" PREAMBLE_DETECT";"-";"-";"-";"RX_ACTIVE rx_start";"-";"-";"-";"-";"-"
" RX_THRESH";"-";"-";"-";"-";"RX_ACTIVE rx_fetch_ff";"-";"-";"-";"CRC_FLUSH rx_drain_ff"
" STANDBY";"STANDBY config";"-";"-";"STANDBY standby";"STANDBY standby";"STANDBY standby";"-";"-";"STANDBY standby"
" SYNC_DETECT";"-";"-";"-";"-";"RX_ACTIVE nop";"-";"-";"-";"-"
" TRANSMIT";"-";"-";"-";"TX_ACTIVE tx_start";"-";"-";"-";"-";"-"
" TURNOFF";"-";"-";"-";"SDN pwr_dn";"SDN pwr_dn";"SDN pwr_dn";"SDN pwr_dn";"-";"-"
" TURNON";"POR_W unshut";"-";"-";"-";"-";"-";"RX_ON ready";"-";"-"
" TX_THRESH";"-";"-";"-";"-";"-";"TX_ACTIVE tx_fill_ff";"-";"-";"-"
" WAIT_DONE";"-";"PWR_UP_W pwr_up";"-";"-";"RX_ON rx_timeout";"RX_ON tx_timeout";"-";"CONFIG_W config";"RX_ON rx_timeout"
```


### FSM CODE GENERATOR

The state machine graphical representation is converted into C and Python definitions by the
FSM code generator, ```gh:MamMark/mm/tools/fsmc.py```.

fsmc.py takes the text representation of the state machine (Si446xFSM.txt) and
converts it into Si446xFSM.h or Si446xFSM.py for use by the drivers.


```
invocation:
    python2 <path to fsmc.py>/fsmc.py  --c-mode      -i Si446xFSM.txt -o Si446xFSM.h
    python2 <path to fsmc.py>/fsmc.py  --python-mode -i Si446xFSM.txt -o Si446xFSM.py
```


## Required tools:
### fsmc.py - finite state machine compiler
- fsmc.py: ```gh:MamMark/mm/tools/fsmc```

### Qfsm

Qfsm is a graphical fsm editor written in C++ using the Qt4 graphics toolkit.  Qt is now sold
commercially (open source is available but hard to find).  Qt5 is now the current release and Qt6
is on the horizon.

Because of its commerical licensing, Qt is no longer bundled with Ubuntu starting with 20.04.  Qt4
is still supported on 18.04.


### Running Qfsm

The simplest way to obtain Qfsm is via an AppImage.  The AppImage is a workaround for Qt4 being dropped by 20.04
and will run on most if not all Linux distributions.  This image is available from the master repository.

- Download the Qfsm AppImage: [Qfsm-x86_64.AppImage](https://github.com/AaronErhardt/qfsm/releases/download/0.56/Qfsm-x86_64.AppImage)
- Make the AppImage executable: ```chmod +x Qfsm-x86_64.AppImage```
- You can run the image from the cli: ```./Qfsm-x86_64.AppImage <input.fsm>```

### Building Qfsm

Alternatively, one can build Qfsm from source.  These instructions are written for 18.04 and Qt4.

- Source code can be found at [gh:MamMark/qfsm](https://github.com/MamMark/qfsm).
- The master repository can be found at [gh:AaronErhardt/qfsm](https://github.com/AaronErhardt/qfsm)
- Install the following components (Ubuntu 18.04)
```
    sudo apt install build-essential cmake graphviz libgraphviz-dev
    sudo apt install qt4-default libqt4-dev
```
There is a Qt4 PPA maintained by rock-core that includes packages for 20.04.
```
    sudo add-apt-repository ppa:rock-core/qt4
    sudo apt update
    sudo apt install qt4-x11
```

- Download the Qfsm source code [gh:MamMark/qfsm](https://github.com/MamMark/qfsm).
```
    cd ~/tag
    git clone https://github.com/MamMark/qfsm.git
    cd qfsm
```

- Build

From INSTALL file in source directory.
```
    cd ~/tag/qfsm
    cmake .
    make
    sudo make install
```
